# use header origin if referer is empty
map $http_referer $reqref {                                                 
    default   $http_referer;                                               
    ""        $http_origin;                                                      
}

log_format operation escape=json 'secretdev1 {"t": $request_time,"s": $status,"o": "$upstream_http_x_owner","h": "$host","i": "$cookie_id_token","io": "$cookie_id_token_org","ak": "$http_x_apikey","a": "$http_x_account","p": "$http_x_processing","c": "$upstream_cache_status","rs": "$upstream_http_x_resource","op": "$upstream_http_x_operation","r": "$reqref","b": $bytes_sent}';

server {
    listen 6202;
    server_name localhost;

    location / {
        access_log syslog:server=localhost:51432 operation if=$upstream_http_x_operation;
        proxy_pass http://localhost:6203;
        proxy_set_header Host $http_host;
    	proxy_cache_bypass $http_upgrade;
    }
}
